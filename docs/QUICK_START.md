# Быстрый запуск

Оглавление:

- Рекомендуемые системные требования
- Запуск цифрового двойника
  - Способ 1. Запуск цифрового двойника с использованием Docker
    - Установка необходимых пакетов и подготовка к запуску
    - Запуск цифрового двойника
  - Способ 2. Запуск цифрового двойника без использования Docker
    - Установка необходимых пакетов и подготовка к запуску
    - Запуск цифрового двойника
    - Запуск сервера ОрВД
- Запуск исполнения миссии
  - Использование APM Planner 2
  - Использование Mission Planner

## Рекомендуемые системные требования

Ниже представлены рекомендуемые системные требования к компьютеру разработчика. 
Предполагается, что данные конфигурации позволят комфортно запустить все компоненты, собирать и отлаживать собственные решения на базе KasperskyOS.
Использовать менее производительные компьютеры возможно, но на свой страх и риск.

### Ubuntu 22.04

- x86_64 6 ядерный процессор
- 8Gb оперативной памяти
- 50Gb свободного дискового пространства

### Windows 10 или 11 + WSL2

- x86_64 6 ядерный процессор
- 8Gb оперативной памяти
- 50Gb свободного диского пространства

### Linux/Windows + VirtualBox

- x86_64 8 ядерный процессор
- 16 Gb оперативной памяти
- 70 Gb свободного дискогового пространства

## Запуск цифрового двойника

Запускать цифровой двойник можно двумя способами. Для любого из способов необходимо клонировать репозиторий проекта и разместить в корневой директории SDK KasperskyOS версии 1.3:

```bash
# Клонирование репозитория с симулятором (вместо cyberimmunity-edu может быть fork)
git clone https://gitflic.ru/project/learning-cyberimmunity/cyberimmune-systems-autonomous-delivery-drone-with-kos.git

# Размещение KasperskyOS CE SDK 1.3.0.166 в папке проекта
cp ~/Downloads/KasperskyOS-Community-Edition-RaspberryPi4b-1.3.0.166_ru.deb cyberimmune-systems-autonomous-delivery-drone-with-kos/
```

### Способ 1. Запуск цифрового двойника с использованием Docker

Данный способ подходит для любых Linux-систем (включая запущенные в VirtualBox или в Windows WSL2).
Все компоненты цифрового двойника запускаются в контейнере. Планировщик с графическим интерфейсом может запускаться как на хост-системе, так и на другом компьютере имеющим доступ к первому по сети.

#### Установка необходимых пакетов и подготовка к запуску

Перед сборкой и запуском проекта необходимо убедиться, что в Linux установлены необходимые пакеты, и что все пакеты обновлены до актуальных версий. Это можно сделать следующими командами терминала:

```bash
# Получение информации о свежих версиях пакетов для дистрибутива
sudo apt-get update

# Установка необходимых пакетов
sudo apt-get install -y git make docker-compose docker.io libfuse2

# Удаление ненужных пакетов
sudo apt-get remove modemmanager -y

# Добавления пользователя user в нужные группы (если у вас другое имя пользователя, используйте его)
sudo usermod -aG sudo,docker,dialout user
```

#### Запуск цифрового двойника

Запуск проекта осуществляется следующим образом:

```bash
cd cyberimmune-systems-autonomous-delivery-drone-with-kos

# Запуск контейнеров с ОрВД, SITL-симулятором, модулем безопасности на KasperskyOS и MAVProxy
make online

# Или:
# Запуск контейнеров с SITL-симулятором, модулем безопасности на KasperskyOS и MAVProxy, без ОрВД
make offline
```

### Способ 2. Запуск цифрового двойника без использования Docker

Данный способ подходит для запуска в Ubuntu 22.04. Все компоненты устанавливаются на хост-систему.

#### Установка необходимых пакетов и подготовка к запуску

Для установки зависимостей необходимо запустить скрипт `install_dependencies.sh`:

```bash
./install_dependencies.sh
```

#### Запуск цифрового двойника

Сборка и запуск осуществляется при помощи скрипта `run.sh`:

```bash
# Запуск SITL-симулятора, модуля безопасности на KasperskyOS и MAVProxy; сервер ОрВД должен быть запущен отдельно
./run.sh

# Или:
# Запуск SITL-симулятора, модуля безопасности на KasperskyOS и MAVProxy; сервер ОрВД не требуется
./run.sh --no-server
```

#### Запуск сервера ОрВД

Для запуска сервера на хост-системе его необходимо установить:

```bash
cd ./cyberimmune-systems-autonomous-delivery-drone-with-kos/orvd
sudo chmod +x install.sh update.sh restart.sh
sudo ./install.sh
```

После этого сервер будет доступен по IP-адресу виртуальной машины. IP-адрес машины можно получить через `ifconfig` (или `ip a`).

Обновить сервер можно выполнив команду `sudo ./update.sh`, перезапустить - командой `sudo ./restart.sh`.

## Запуск исполнения миссии

При использовании нативной Linux или запуске проекта в виртуальной машине в качестве наземной станции рекомендуется использовать APM Planner. При запуске проекта вторым способо он вызывается автоматически; при проекта первым способом его можно вызвать из папки planner командой `./APM_Planner.AppImage`.

При использовании WSL и Docker, установленного в системе Windows, в качестве наземной станции рекомендуется использовать Mission Planner. Чтобы телеметрия передавалась в Mission Planner необходимо указать IP-адрес системы Windows в параметрах `--out` и `--master` в запуске mavproxy в файле `docker-compose-*.yml`.

### Использование APM Planner 2

1. Запустить проект и APM Planner 2 одним из описанных ранее способов.
2. Загрузить миссию в автопилот в APM Planner 2:
  1. Открыть вкладку "Flight Plan"
  2. Нажать кнопку "Edit Waypoints"
  3. Нажать кнопку "Load WPs" и выбрать файл с миссией, либо задать миссию в интерфейсе APM Planner
  4. Нажать кнопку "Write"
3. Если проект запущен в онлайн-режиме, необходимо загрузить миссию на сервер ОрВД и подтвердить ее
  1. Открыть начальную страницу СУПА и перейти на вкладку "Mission Sender"
  2. В поле ID указать идентификатор квадрокоптера (можно посмотреть в СУПА)
  3. Выбрать файл с миссией
  4. Нажать кнопку "Отправить"
  5. Убедиться, что миссия отобразилась на карте
  6. Нажать галочку "Подтверждение миссии"
4. Запустить квадрокоптер в APM Planner 2:
  1. Открыть вкладку "Flight Data"
  2. Открыть раздел "Actions"
  3. Нажать кнопку "ARM". Первая попытка ARM будет неудачной, но вызовет запрос на ARM к серверу. В offline-сборке разрешение будет дано немедленно
  4. (Только для онлайн-сборки) На странцие СУПА дождаться, чтобы кнопки "Arm" и "Disarm" загорелись зеленым
  5. (Только для онлайн-сборки) На странице СУПА нажать кнопку "Arm" для подтверждения миссии
  6. Нажать на кнопку "ARM" повторно (в APM Planner 2). Квадрокоптер будет переведен в режим "Armed"
  7. Выбрать команду "Mission Start" из выпадающего списка рядом с кнопкой "Execute Action"
  8. Нажать кнопку "Execute Action"

### Использование Mission Planner

1. Запустить проект одним из описанных способов
2. Запустить Mission Planner
3. Загрузить миссию в автопилот в Mission Planner:
  1. Открыть вкладку "Plan"
  2. Нажать кнопку "Загрузить WP-файл" и выбрать файл с миссией, либо задать миссию в интерфейсе Mission Planner
  3. Нажать кнопку "Записать WP"
4. Если проект запущен в онлайн-режиме, необходимо загрузить миссию на сервер ОрВД и подтвердить ее
  1. Открыть начальную страницу СУПА и перейти на вкладку "Mission Sender"
  2. В поле ID указать идентификатор квадрокоптера (можно посмотреть в СУПА)
  3. Выбрать файл с миссией
  4. Нажать кнопку "Отправить"
  5. Убедиться, что миссия отобразилась на карте
  6. Нажать галочку "Подтверждение миссии"
5. Запустить квадрокоптер в Mission Planner:
  1. Открыть вкладку "Data"
  2. Открыть раздел "Действия"
  3. Нажать кнопку "Arm/Disarm". Первая попытка ARM будет неудачной, но вызовет запрос на ARM к серверу. В offline-сборке разрешение будет дано немедленно
  4. (Только для онлайн-сборки) На странцие СУПА дождаться, чтобы кнопки "Arm" и "Disarm" загорелись зеленым
  5. (Только для онлайн-сборки) На странице СУПА нажать кнопку "Arm" для подтверждения миссии
  6. Нажать на кнопку "Arm/Disarm" повторно. Квадрокоптер будет перевед в режим "Armed"
  7. Выбрать команду "Mission_Start" из выпадающего списка рядом с кнопкой "Выполнить"
  8. Нажать кнопку "Выполнить"
  
## Работа с запрещенными зонами в панели оператора

В панели оператора зайти во вкладку "Запрещенные зоны", авторизироваться.

- Для создания новой зоны: войти в режим рисования (кнопка "Нарисовать новую зону"), расставить точки на карте (зона должна быть несамопересекающаяся), ввести имя зоны в "Имя зоны" и нажать на кнопку "Сохранить зону"
- Для удаления существующей зоны: нажать на зону на карте, затем нажать на кнопку "Удалить выбранную зону"
- Для экспорта существующих зон (в GeoJSON): нажать на кнопку "Экспортировать зоны"
- Для импорта зон из GeoJSON: нажать на кнопку "Импортировать зоны" и выбрать необходимый файл
